---
slug: github-package-registry-actions
title: GitHub Package Registry + GitHub Actions
description: Como utilizar GitHub Actions para publicar um pacote do npm no GitHub Package Registry.
date: 2019-09-27
category: Tutorial
tags: ['node', 'npm', 'github']
photo: ./photo.jpg
photoCredit: Janko Ferliƒç
photoLink: https://unsplash.com/photos/zLguZrNzcO0
photoAlt: Sob um gramado e uma √°rvore a esquerda observando um lindo por do sol.
---

- Introdu√ß√£o
- O que √© GitHub Actions?
- O que √© GitHub Package Registry?
- Definindo o workflow
- Criando um workflow para publicar pacotes no GitHub Package Registry usando o GitHub Actions
- Enviando o workflow para o GitHub
- Acompanhando a execu√ß√£o do workflow
- Conclus√£o
- Solu√ß√£o de problemas

## Introdu√ß√£o

As pr√°ticas de _Continuous Integration_ e _Continuous Delivery_, tamb√©m conhecidas com CI/CD, tem se tornado cada vez mais presentes no _workflow_ dos desenvolvedores. Essas t√©cnicas consistem em integrar c√≥digo com mais frequ√™ncia ao reposit√≥rio, permitindo que os desenvolvedores descubram erros mais rapidamente, por exemplo. Existe outros benef√≠cios, √© claro.

Existem servi√ßos de CI/CD dispon√≠veis na Internet que permitem que os desenvolvedores construam seus _workflows_ de CI/CD. Os mais conhecidos e utilizados s√£o: [CircleCI](https://circleci.com) e [Travis CI](https://travis-ci.org/).

Um _workflow_ muito utilizado pelos desenvolvedores JavaScript √© utilizar o **GitHub** para gerenciar o c√≥digo, **CircleCI** ou **Travis CI** para gerenciar o CI/CD e o **npm** para publicar os pacotes.

## O que √© GitHub Actions?

**GitHub Actions** √© uma das novas funcionalidades que o GitHub lan√ßou recentemente. A proposta √© disponibilizar um servi√ßo de CI/CD dentro do GitHub. üëÄ

Para utilizar o GitHub Actions √© necess√°rio criar um arquivo `YAML` no diret√≥rio `.github/workflows`. Assim que o arquivo for criado no reposit√≥rio, o GitHub identifica esse arquivo e executa o _workflow_.

No _workflow_ podemos configurar a execu√ß√£o de testes, _build_ e _deploy_, por exemplo.

> Essa funcionalidade ainda est√° em fase `beta`. Caso voc√™ queira se inscrever para participar, acesse a [p√°gina do GitHub Actions](https://github.com/features/actions).

## O que √© GitHub Package Registry?

O **GitHub Package Registry** √© um servi√ßo de hospedagem de pacotes, semelhante ao `npm`, que permite que voc√™ hospede seus c√≥digos e pacotes em um √∫nico lugar. Ele suporta pacotes do `Node.js`, `Ruby`, `Java`, `.NET` e imagens `Docker`.

Esse tutorial √© a continua√ß√£o do tutorial anterior [Como utilizar o GitHub Package Registry com o npm](/blog/github-package-registry-npm).

## Definindo o _workflow_

Nosso objetivo √© simples: publicar um pacote automaticamente sempre que houver uma altera√ß√£o na _branch master_. Os passos necess√°rios para isso s√£o:

- Identificar uma altera√ß√£o na _branch master_ seja atrav√©s de `push` ou `Pull Request`
- Executar algumas a√ß√µes para publicar o pacote

## Criando um _workflow_ para publicar pacotes no GitHub Package Registry usando o GitHub Actions

O primeiro passo para criar um _workflow_ no GitHub Actions √© criar um arquivo no diret√≥rio `.github/workflows`. O nome do arquivo pode ser qualquer coisa, desde que tenha a extens√£o `.yml`. Eu vou utilizar `gpr-publish.yml`. Eu vou apresentar o arquivo completo e comentar todas as etapas detalhadamente.

```yaml
name: GPR Publish

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  publish-gpr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-node@v1
        with:
          node-version: 12
          registry-url: https://npm.pkg.github.com/
          scope: '@robertoachar'
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
```

### Nome do _workflow_

Esse √© o nome que ser√° exibido no GitHub para identificar o _workflow_.

```yaml
name: GPR Publish
```

### Definindo a condi√ß√£o para a execu√ß√£o do _workflow_

Essa configura√ß√£o instrui o _workflow_ a ser executado apenas quando houver um `Pull Request` ou um `Push` na _branch_ **master**.

```yaml
on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
```

### Definindo o job

Todo _workflow_ precisa ter pelo menos um _job_ e podemos definir mais de um _job_ por _workflow_. Nesse caso estamos definindo apenas um _job_: `publish-gpr`. Esse _job_ ser√° executado sempre que a condi√ß√£o acima for atendida.

```yaml
jobs: publish-gpr:
```

### Escolhendo o ambiente de execu√ß√£o

Os _workflows_ podem ser executados em uma m√°quina virtual ou em um _container_ Docker. Nesse caso iremos executar o _workflow_ em uma m√°quina virtual com a √∫ltima vers√£o do sistema operacional `Ubuntu`.

```yaml
runs-on: ubuntu-latest
```

### Passos da execu√ß√£o

Um _job_ cont√©m um mais passos a serem executados. Os passos podem ser a execu√ß√£o de comandos ou utilizar uma a√ß√£o.

```yaml
steps:
```

### A√ß√£o `checkout`

A a√ß√£o `checkout` √© uma a√ß√£o padr√£o e precisa ser inclu√≠da antes das outras a√ß√µes. Ela √© respons√°vel por requisitar uma c√≥pia do c√≥digo do reposit√≥rio.

```yaml
- uses: actions/checkout@v1
```

### A√ß√£o `setup-node`

Essa a√ß√£o √© respons√°vel por configurar o `Node` no ambiente de execu√ß√£o. Solicitamos a instala√ß√£o da vers√£o 12 do `Node.js`, informamos qual √© a `url` do `registry` e informamos qual √© o `scope` (leia nome de usu√°rio ou organiza√ß√£o do GitHub).

```yaml
- uses: actions/setup-node@v1
  with:
    node-version: 12
    registry-url: https://npm.pkg.github.com/
    scope: '@robertoachar'
```

### Publicando o pacote

Informamos ao _workflow_ para executar o comando `npm publish` e configuramos a vari√°vel de ambiente `NODE_AUTH_TOKEN` com o valor de `GITHUB_TOKEN`. O GitHub cria `GITHUB_TOKEN` por padr√£o, mas precisamos inclu√≠-lo nas configura√ß√µes para que as a√ß√µes possam us√°-lo.

```yaml
- run: npm publish
  env:
    NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
```

## Enviando o _workflow_ para o GitHub

Como o _workflow_ √© apenas um arquivo no reposit√≥rio, para enviar o _workflow_ para o GitHub, basta realizar o _commit_ desse arquivo no reposit√≥rio. Se esse arquivo for enviado para a _branch master_ atrav√©s de `push` ou `Pull Request`, o _job_ ser√° executado e seu pacote ser√° publicado automaticamente.

## Acompanhando a execu√ß√£o do _workflow_

1. Acesse a p√°gina do seu reposit√≥rio no GitHub

2. Clique em `Actions`

![Tela do reposit√≥rio dando √™nfase no link Actions](images/github-repo.jpg)

3. Visualize todos os _workflows_ dispon√≠veis

![Tela do reposit√≥rio exibindo os workflows](images/github-actions.jpg)

4. Clique em um _workflow_ para ver os detalhes

![Tela do reposit√≥rio exibindo um workflow espec√≠fico](images/github-action.jpg)

5. Clique em uma etapa para visualizar o `log` de execu√ß√£o

![Tela do reposit√≥rio exibindo o detalhe de execu√ß√£o de um workflow](images/github-action-detail.jpg)

## Conclus√£o

O GitHub vem se tornando cada vez mais uma ferramenta indispens√°vel para os desenvolvedores. Essas duas novas funcionalidades, GitHub Actions e GitHub Package Registry, agregam muito valor ao ciclo de desenvolvimento.

## Solu√ß√£o de problemas

### Recebi o erro `EPUBLISHCONFLICT` na hora de publicar o pacote

```bash
$ npm publish

npm ERR! code EPUBLISHCONFLICT
npm ERR! publish fail Cannot publish over existing version.
npm ERR! publish fail Update the 'version' field in package.json and try again.
npm ERR! publish fail
npm ERR! publish fail To automatically increment version numbers, see:
npm ERR! publish fail     npm help version
```

**Solu√ß√£o**: voc√™ n√£o pode publicar um pacote com a mesma vers√£o que j√° foi publicada. Altere a vers√£o do seu pacote e tente publicar novamente.
