---
slug: yarn-workspaces
title: Monorepo + Yarn Workspaces
description: Como configurar um Monorepo utilizando o Yarn Workspaces.
date: 2019-10-15
category: Tutorial
tags: [monorepo, yarn, workspaces]
photo: ./photo.jpg
photoCredit: Dan Stark
photoLink: https://unsplash.com/photos/DLwUVlzrP0Q
photoAlt: Um lindo oceano com ondas batendo nas pedras.
---

- Introdu√ß√£o
- O que √© Monorepo?
- O que √© Yarn?
- O que √© Yarn Workspaces?
- Como instalar o Yarn?
- Construindo o primeiro Monorepo
- Configurando os scripts
- Instalando depend√™ncias
- Conclus√£o

## Introdu√ß√£o

Esse √© o primeiro de alguns tutoriais que quero escrever sobre **Monorepo** utilizando o **Yarn Workspaces**. Venho utilizando bastante essa estrat√©gia e tenho gostado do resultado.

## O que √© Monorepo?

**Monorepo** √© uma estrat√©gia de desenvolvimento de software onde o c√≥digo de v√°rias aplica√ß√µes s√£o agrupadas em um mesmo reposit√≥rio.

Essa t√©cnica n√£o √© nova, muito pelo contr√°rio, ela j√° exite h√° muitos anos, ela apenas ganhou um nome (como tudo hoje em dia ü§≠).

### Vantagens

- **Ambiente de desenvolvimento**: facilidade para executar o ambiente de desenvolvimento. Basta clonar um √∫nico reposit√≥rio, instalar as depend√™ncias de todas as aplica√ß√µes com um √∫nico comando e executar com outro comando.

- **Reutiliza√ß√£o de c√≥digo**: funcionalidades compartilhadas podem ser facilmente extra√≠das em uma aplica√ß√£o separada e reutilizadas em outras aplica√ß√µes.

- **Gerenciamento de depend√™ncias**: em m√∫ltiplos reposit√≥rios, uma depend√™ncia externa ser√° baixada m√∫ltiplas vezes. No Monorepo, a depend√™ncia externa pode ser otimizada e reutilizada.

- **Gerenciamento de vers√µes**: em m√∫ltiplos reposit√≥rios, quando uma aplica√ß√£o √© versionada, todas as outras aplica√ß√µes que dependem dela precisam ser atualizadas. No Monorepo, n√£o h√° essa necessidade, pois o c√≥digo est√° _linkado_.

### Desvantagens

- **CI/CD**: realizar o _Continuous Integration_ ou _Continuous Delivery_ com Monorepo pode ser complicado. N√£o √© f√°cil identificar qual aplica√ß√£o foi alterada para iniciar os processos de **CI/CD** apenas para ela.

- **Seguran√ßa**: como todas as aplica√ß√µes est√£o no mesmo reposit√≥rio, os desenvolvedores t√™m acesso a tudo. Isso pode causar alguns problemas de seguran√ßa. **Obs.:** h√° aplica√ß√µes em que esse cen√°rio n√£o √© considerado uma desvantagem.

- **Equ√≠vocos**: com muitas aplica√ß√µes em um mesmo reposit√≥rio, se n√£o prestar aten√ß√£o no diret√≥rio que est√° aberto no Terminal, voc√™ acaba executando ou instalando alguma depend√™ncia na aplica√ß√£o errada.

## O que √© Yarn?

**Yarn** √© uma alternativa ao **npm**, √© um gerenciador de depend√™ncias do Node. Ele foi criado para tentar resolver alguns problemas do **npm**.

Para mais informa√ß√µes sobre o Yarn: [https://yarnpkg.com](https://yarnpkg.com).

## O que √© Yarn Workspaces?

Workspaces √© uma funcionalidade do Yarn que permite agrupar m√∫ltiplas aplica√ß√µes em um √∫nico reposit√≥rio. Ele √© o grande facilitador para a cria√ß√£o de Monorepos. Basta informar quais s√£o os diret√≥rios no arquivo `package.json` para que o Yarn seja capaz de instalar as depend√™ncias e _linkar_ as aplica√ß√µes locais.

Para mais informa√ß√µes sobre o Yarn Workspaces: [https://yarnpkg.com/en/docs/workspaces](https://yarnpkg.com/en/docs/workspaces).

## Como instalar o Yarn?

Acesse a [p√°gina com as instru√ß√µes de instala√ß√£o](https://yarnpkg.com/en/docs/install), escolha o sistema operacional, a vers√£o e siga os passos descritos nessa p√°gina. Para verificar se a instala√ß√£o ocorreu com sucesso, abra o Terminal e digite:

```bash
$ yarn --version
1.19.1
```

Se quiser entender mais como o Yarn funciona, acesse a documenta√ß√£o: [https://yarnpkg.com/en/docs](https://yarnpkg.com/en/docs).

## Construindo o primeiro Monorepo

Nesse tutorial, iremos construir um Monorepo com duas aplica√ß√µes extremamente simples:

- `sum`: biblioteca que exporta uma funcionalidade para somar dois n√∫meros
- `calc`: aplica√ß√£o que utiliza a funcionalidade de soma

### Criando o reposit√≥rio principal

O primeiro passo √© criar o diret√≥rio principal e inicializar uma nova aplica√ß√£o `Node`. Para isso, abra o Terminal e digite:

```bash
$ mkdir monorepo
$ cd monorepo
$ yarn init -y
```

Esse comando gera o arquivo `package.json` na ra√≠z da aplica√ß√£o:

```json
{
  "name": "monorepo",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT"
}
```

Como o `package.json` principal n√£o vai exportar nenhuma funcionalidade, precisamos fazer 02 altera√ß√µes:

1. Excluir o campo `main`
2. Adicionar o campo `private` como `true`, para que o reposit√≥rio n√£o seja publicado acidentalmente

```json
{
  "name": "monorepo",
  "version": "1.0.0",
  "license": "MIT",
  "private": true
}
```

### Configurando o Workspace

Para configurar o Monorepo √© necess√°rio criar o campo `workspaces` no arquivo `package.json`. H√° duas maneiras de configurar o campo `workspaces`.

1. Criar os diret√≥rios `calc` e `sum` na ra√≠z do reposit√≥rio e adicionar o nome das duas aplica√ß√µes no campo `workspaces` no arquivo `package.json`. O problema dessa maneira √© que sempre que formos adicionar ou excluir aplica√ß√µes do _workspace_, precisamos lembrar de alterar o arquivo `package.json`.

**Estrutura de arquivos e diret√≥rios**

```text
.
|--- calc
|--- sum
|--- package.json
```

**Arquivo package.json**

```json
{
  "workspaces": ["sum", "calc"]
}
```

2. Criar um diret√≥rio `packages` na ra√≠z, criar os diret√≥rios `calc` e `sum` dentro do diret√≥rio `packages` e adicionar um _glob_ no campo `workspaces` no arquivo `package.json`. Essa √© a melhor maneira, pois informamos ao Yarn que todas as aplica√ß√µes dentro do diret√≥rio `packages` fazem parte do _workspace_. Com isso n√£o precisamos mais nos preocupar com o campo `workspaces`.

```text
.
|--- packages
|    |--- calc
|    |--- sum
|--- package.json
```

```json
{
  "workspaces": {
    "packages": ["packages/*"]
  }
}
```

Nesse tutorial iremos utilizar a segunda op√ß√£o.

### Criando a biblioteca

Crie um diret√≥rio `sum` dentro do diret√≥rio `packages`, abra o diret√≥rio `sum` no Terminal e digite `yarn init -y`. Esse comando inicializa uma nova aplica√ß√£o `Node` no diret√≥rio `sum`.

```json
{
  "name": "sum",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT"
}
```

Crie o arquivo `index.js` no diret√≥rio `sum`.

```javascript
module.exports = (x, y) => {
  return x + y;
};
```

### Criando a aplica√ß√£o

Crie um diret√≥rio `calc` dentro do diret√≥rio `packages`, abra o diret√≥rio `calc` no Terminal e digite `yarn init -y`. Esse comando inicializa uma nova aplica√ß√£o `Node` no diret√≥rio `calc`.

```json
{
  "name": "calc",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT"
}
```

Para utilizar a biblioteca `sum` na aplica√ß√£o `calc` √© necess√°rio instal√°-la como depend√™ncia. Abra o diret√≥rio `calc` no Terminal e digite:

```bash
$ yarn add sum@1.0.0
```

> √â necess√°rio utilizar a vers√£o exata do pacote para que o Yarn saiba onde procurar. Se voc√™ n√£o informar a vers√£o, o Yarn vai tentar encontrar o pacote no registro do npm (caso ele seja o _default_).

```json
{
  "dependencies": {
    "sum": "1.0.0"
  }
}
```

Crie o arquivo `index.js` no diret√≥rio `calc`.

```javascript
const sum = require('sum');

const total = sum(5, 5);

console.log(total);
```

Para executar a aplica√ß√£o e testar se tudo est√° funcionando, abra o Terminal no diret√≥rio `calc` e digite:

```bash
$ node index.js
10
```

### Utilizando scoped packages

Podemos utilizar _scoped packages_ tamb√©m.

- Altere o nome do pacote da aplica√ß√£o `calc`

```json
{
  "name": "@monorepo/calc"
}
```

- Altere o nome do pacote da biblioteca `sum`

```json
{
  "name": "@monorepo/sum"
}
```

- Remova e instale novamente a biblioteca `sum`. Abra o diret√≥rio `calc` no Terminal e digite:

```bash
$ yarn remove sum
$ yarn add @monorepo/sum@1.0.0
```

- Altere a refer√™ncia no arquivo `index.js` da aplica√ß√£o `calc`

```javascript
const sum = require('@monorepo/sum');
```

Para executar a aplica√ß√£o e testar se tudo continua funcionando, abra o Terminal no diret√≥rio `calc` e digite:

```bash
$ node index.js
10
```

### Analisando o diret√≥rio node_modules

O Yarn Workspaces j√° faz o trabalho de _linkagem_ das aplica√ß√µes automaticamente para n√≥s. D√™ uma olhada no diret√≥rio _node_modules_.

```bash
$ l node_modules
@monorepo

$ l node_modules/@monorepo
calc -> ../../packages/calc
sum -> ../../packages/sum
```

### Depend√™ncias externas

O processo para instalar depend√™ncias externas √© o mesmo. Abra o diret√≥rio `sum` no Terminal e digite:

```bash
$ yarn add chalk
```

Altere o arquivo `index.js` da aplica√ß√£o `sum`.

```javascript
const chalk = require('chalk');

module.exports = (x, y) => {
  console.log(`Adding ${chalk.blue(x)} + ${chalk.blue(y)}`);

  return x + y;
};
```

Abra o diret√≥rio `calc` no Terminal e digite:

```bash
$ yarn add chalk
```

Altere o arquivo `index.js` da aplica√ß√£o `calc`.

```javascript
const chalk = require('chalk');
const sum = require('@monorepo/sum');

const total = sum(5, 5);

console.log(chalk.green(total));
```

Para executar a aplica√ß√£o e testar se tudo continua funcionando, abra o Terminal no diret√≥rio `calc` e digite:

```bash
$ node index.js
Adding 5 + 5
10
```

## Configurando os scripts

Para configurar os scripts √© muito simples.

### Configurando o script da aplica√ß√£o `calc`

Edite o arquivo `package.json` da aplica√ß√£o `calc` e adicione o script `start`.

```json
{
  "scripts": {
    "start": "node index.js"
  }
}
```

Abra o Terminal no diret√≥rio `calc` e digite:

```bash
$ yarn start
```

**Output**

```bash
yarn run v1.19.1
$ node index.js
Adding 5 + 5
10
‚ú®  Done in 0.20s.
```

### Configurando o script do Monorepo

Edite o arquivo `package.json` do diret√≥rio ra√≠z e adicione o script `start`.

```json
{
  "scripts": {
    "start": "yarn workspace @monorepo/calc start"
  }
}
```

Abra o Terminal no diret√≥rio ra√≠z e digite:

```bash
$ yarn start
```

**Output**

```bash
yarn run v1.19.1
$ yarn workspace @monorepo/calc start
$ node index.js
Adding 5 + 5
10
‚ú®  Done in 1.13s.
```

## Instalando depend√™ncias

Nessa se√ß√£o vamos entender como funciona o processo de instala√ß√£o de depend√™ncias com o Yarn Workspaces. Essa √© uma das grandes vantagens de trabalhar com Monorepo.

Primeiro vamos apagar a pasta `node_modules` para simular que acabamos de clonar o reposit√≥rio. Abra o Terminal no diret√≥rio ra√≠z e digite:

```bash
$ rm -rf node_modules
```

No mesmo diret√≥rio, digite:

```bash
$ yarn
```

Com apenas um comando, todas as depend√™ncias de todas as aplica√ß√µes foram instaladas.

**MAGIC!** üòò

## Conclus√£o

Esse tutorial foi bem introdut√≥rio mas acho que deu para perceber a facilidade de trabalhar com Monorepos e Yarn Workspaces. Pretendo continuar escrevendo sobre esse assunto ao longo das pr√≥ximas semanas.

Caso queira dar uma olhada no c√≥digo final desse tutorial e acompanhar a sequ√™ncia de commits: [https://github.com/robertoachar/monorepo](https://github.com/robertoachar/monorepo).

Gostaria de agradecer ao [Sibelius Seraphini](https://twitter.com/sseraphini) pela revis√£o. Obrigado! üòâ

### Pr√≥ximos passos

- Leia o artigo sobre a [introdu√ß√£o ao Yarn Workspaces](https://yarnpkg.com/blog/2017/08/02/introducing-workspaces/).
- Leia a documenta√ß√£o do [Yarn Workspaces](https://yarnpkg.com/en/docs/workspaces)
- Estude as funcionalidades [`yarn workspaces`](https://yarnpkg.com/en/docs/cli/workspaces) e [`yarn workspace`](https://yarnpkg.com/en/docs/cli/workspace)
